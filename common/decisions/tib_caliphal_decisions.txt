# Expanded decisions for the Caliph!
caliphal_revolution_decision = {
	picture = "gfx/interface/illustrations/decisions/decision_personal_religious.dds"
	major = yes

	ai_check_interval = 24

	desc = appoint_a_righteous_caliph_decision_desc
	selection_tooltip = appoint_a_righteous_caliph_decision_tooltip

	is_shown = {
		# Standard filter checks.
		is_landed = yes
		exists = dynasty
		# Check some religious stuff; namely that you're the correct religion and your existing-HoF doesn't share your faith.
		religion = religion:islam_religion
		exists = faith.religious_head
		NOT = { faith = faith.religious_head.faith }
		# And filter out anyone who'd make this unreliable.
		OR = {
			government_has_flag = government_is_tribal
			government_has_flag = government_is_feudal
			government_has_flag = government_is_clan
            government_has_flag = government_is_islamic
		}
	}

	is_valid = {
		# Should have a decent piety level.
		piety_level >= high_piety_level
		# Must have a decent proportion of sub-realm counties of the faith.
		#custom_description = {
		#	text = appoint_a_righteous_caliph_decision.need_at_least_ten_same_faith_counties
		#	any_sub_realm_county = {
		#		count >= appoint_a_righteous_caliph_decision_same_faith_county_count
		#		faith = root.faith
		#	}
		#}

        # Hates the current Caliph
        faith.religious_head = {
            exists = this
            opinion = {
                target = root
                value < high_positive_opinion
            }
        }
		# Can't be the current caliphal controller
		custom_description = {
			text = appoint_a_righteous_caliph_decision.cant_be_caliphal_controller
			NOT = {
				faith.religious_head = {
					any_liege_or_above = { this = root }
				}
			}
		}
		# Plus, you shouldn't be _too_ sinful, even with your piety level.
		custom_description = {
			text = appoint_a_righteous_caliph_decision.no_more_than_x_sinful_traits
			num_sinful_traits <= 2
		}
		# Now, pick any three of the valid reasons.
		calc_true_if = {
			amount >= 1

			# Sayyids get a free pass.
			has_trait = sayyid
			# Being outside of your caliph's diplo range helps.
			custom_description = {
				text = appoint_a_righteous_caliph_decision.caliph_not_in_diplo_range
				NOT = { in_diplomatic_range = faith.religious_head }
			}
			# Having a higher-than-minimum piety level.
			piety_level >= very_high_piety_level
			# And just having a caliph who doesn't live up to the root's faith's ideals.
			custom_description = {
				text = appoint_a_righteous_caliph_decision.caliph_has_x_or_more_traits_sinful_to_your_faith
				faith.religious_head = {
					num_sinful_traits = {
						value >= 2
						faith = root.faith
					}
				}
			}
			# Has planned to schism off for a *while*.
			custom_description = {
				text = appoint_a_righteous_caliph_decision.has_wishes_to_schism_caliphate_flag
				has_character_flag = wishes_to_schism_caliphate_flag
			}
		}
	}

	is_valid_showing_failures_only = {
		is_available_adult = yes
		# Has to be around for the ceremony.
		not = { exists = involved_activity }
		has_contagious_deadly_disease_trigger = no
		# Has to be a valid priestly gender for the current faith.
		faith = { has_allowed_gender_for_clergy = root }
	}

	effect = {
        save_scope_as = founder
		faith.religious_head = { save_scope_as = old_caliph }
        # PREREQUISITES ASPECT
        custom_tooltip = appoint_a_righteous_caliph_decision.tt.you_become_caliph
        # Give scope:founder an extra piety level, if possible.
        if = {
            limit = { piety_level < max_piety_level }
            add_piety_level = 1
        }
        # Try to scope:founder rivals with scope:old_caliph.
        if = {
            limit = {
                can_set_relation_rival_trigger = { CHARACTER = scope:old_caliph }
            }
            set_relation_rival = {
                target = scope:old_caliph
                reason = rival_old_caliph_new_caliph
            }
        }
        # If you've pulled a fast one on your HoF, they see through it.
        if = {
            limit = { has_character_flag = wishes_to_schism_caliphate_flag }
            scope:old_caliph = {
                remove_opinion = {
                    target = scope:founder
                    modifier = repentant_opinion
                }
            }
            remove_hook = {
                target = scope:old_caliph
                type = indebted_hook
            }
        }
        # And sort a bit of stress impact for the gravity of things.
        stress_impact = {
            base = major_stress_impact_gain
            humble = major_stress_impact_gain
            arrogant = medium_stress_impact_loss
        }
        # END

        ## REVOLUTION ASPECT
		# Gives army to the contender
        spawn_army = {
            uses_supply = no
            inheritable = yes
            name = "Caliphal Jihadists"
            men_at_arms = {
                type = abudrar
                stacks = 5
            }
            men_at_arms = {
                type = light_horsemen
                stacks = 5
            }
            men_at_arms = {
                type = light_horsemen
                stacks = 5
            }
            men_at_arms = {
                type = armored_horsemen
                stacks = 5
            }
            men_at_arms = {
                type = mangonel
                stacks = 1
            }
            men_at_arms = {
                type = bowmen
                stacks = 3
            }
            men_at_arms = {
                type = pikemen_unit
                stacks = 3
            }
            location = capital_province
        }

        # Declares and launches war against the targeted Caliphate
        scope:ROOT = {
            limit = { # If the Caliph is a vassal
                scope:old_caliph = {
                    is_independent_ruler = no
                }
                start_war = { # Attacks the top vassal and the Caliph
                    cb = invasion_war
                    target = {
                        scope:old_caliph
                        scope:old_caliph.top_liege
                    }
                    target_title = {
                        highest_held_title_tier >= tier_duchy
                        this = scope:old_caliph
                    }
                    target_title = scope:old_caliph.religious_head_title
                    save_scope_as = caliphal_revolution_war
                }
            }

			start_war = { # For independent Caliphate
				cb = invasion_war
				target = scope:old_caliph
				target_title = {
                    highest_held_title_tier >= tier_duchy
                    this = scope:old_caliph
                }
                target_title = scope:old_caliph.religious_head_title
                save_scope_as = caliphal_revolution_war
			}
		}

		# Notify co-faithists; we do this first so we can sort the feed message for how many did/didn't convert.
		faith = {
			every_faith_ruler = {
				limit = {
					highest_held_title_tier >= tier_county
					NOT = { this = root }
				}
				trigger_event = religious_decision.0602
			}
		}
		# Now notify other players.
		every_player = {
			limit = {
				OR = {
					religion = religion:islam_religion
					any_neighboring_and_across_water_top_liege_realm_owner = { this = root }
					any_liege_or_above = { religion = religion:islam_religion }
				}
				# Exempt same-faith characters, who already got an event.
				NOT = { faith = root.faith }
			}
			# Players who share the faith get 
			trigger_event = religious_decision.0603
		}
		# Finally, we trigger the main transfer of power. (or lack thereof)
		scope:caliphal_revolution_war = {
            on_victory = {
                scope:ROOT = {
                    trigger_event = caliphal_transfer_of_power # Non-Sayyids will get a Sayyid? trait to legitimise their claim to the caliphate
                }
            }
        }

	}

	cost = {
		prestige = 1000
		piety = 4000
	}

	ai_potential = {
		# Must be independent.
		#is_independent_ruler = yes
		# Should have a decent piety level.
		piety_level >= high_piety_level
		OR = {
			# Zealous people think they know better.
			has_trait = zealous
			# And cynics want that power for themselves.
			has_trait = cynical
			# We guide Muwalladi towards this at the first opportunity.
			faith = faith:muwalladi
            AND = { # For Sayyid individuals
                OR = {
                    # Zealous people think they know better.
			        has_trait = zealous
			        # And cynics want that power for themselves.
			        has_trait = cynical
                    # Ambitious individuals
                    has_trait = ambitious
                }
                has_trait = sayyid
            }
		}
	}

	ai_will_do = {
		base = 100
	}
}